name: Compare Metadata Between Two Salesforce Orgs

on:
  workflow_dispatch:

jobs:
  compare-metadata:
    runs-on: ubuntu-latest

    env:
      ORG1_ALIAS: Org1
      ORG2_ALIAS: Org2

    steps:
      # 1. Checkout the current repository.
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. Set up Node.js and install Salesforce CLI.
      - name: Set up Node and Salesforce CLI
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 3. Install Salesforce CLI and Hardis Plugin.
      - name: Install Salesforce CLI and Hardis Plugin
        run: |
          npm install --global @salesforce/cli
          # Install the Hardis plugin; ensure that the plugin name is correct.
          sf plugins install sfdx-hardis

      # 4. Authenticate to Org 1 using the provided Auth URL.
      - name: Authenticate to Org 1
        run: |
          # Create an authentication file for Org1.
          # The secret SFDX_AUTH_ORG1_URL must be a plain text string in the format:
          # force://<clientId>:<clientSecret>:<refreshToken>@<instanceUrl>
          # Note: If your client secret is empty, update the value to include a placeholder (e.g., dummySecret)
          echo "${{ secrets.SFDX_AUTH_ORG1_URL }}" > auth-org1.txt
          # Perform authentication.
          sf org login sfdx-url --sfdx-url-file auth-org1.txt --alias $ORG1_ALIAS --set-default

      # 5. Retrieve Metadata from Org 1.
      - name: Retrieve Metadata from Org 1
        run: |
          mkdir -p metadata-org1
          cd metadata-org1
          # Retrieve metadata using the Hardis plugin.
          sf hardis:retrieve -u $ORG1_ALIAS -n "FullRetrieveOrg1"

      # 6. Commit Org 1 metadata to branch 'main'.
      - name: Commit Org 1 Metadata on main branch
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "GitHub Action Bot"
          git checkout main || git checkout -b main
          # Copy retrieved metadata to the project source folder (adjust "force-app" if needed)
          rsync -a metadata-org1/ force-app/
          git add .
          git commit -m "Org1 metadata retrieved" || echo "No changes in Org1 metadata"
          git push origin main

      # 7. Authenticate to Org 2 using the provided Auth URL.
      - name: Authenticate to Org 2
        run: |
          echo "${{ secrets.SFDX_AUTH_ORG2_URL }}" > auth-org2.txt
          sf org login sfdx-url --sfdx-url-file auth-org2.txt --alias $ORG2_ALIAS --set-default

      # 8. Retrieve Metadata from Org 2.
      - name: Retrieve Metadata from Org 2
        run: |
          mkdir -p metadata-org2
          cd metadata-org2
          sf hardis:retrieve -u $ORG2_ALIAS -n "FullRetrieveOrg2"

      # 9. Commit Org 2 metadata to branch 'org2'.
      - name: Commit Org 2 Metadata on branch org2
        run: |
          git checkout -B org2
          rsync -a --delete metadata-org2/ force-app/
          git add .
          git commit -m "Org2 metadata retrieved" || echo "No changes in Org2 metadata"
          git push origin org2 --force

      # 10. Compare the metadata between the two branches.
      - name: Compare Metadata Differences Between Org1 and Org2
        run: |
          git diff main org2 > metadata-diff.txt
          echo "Differences saved to metadata-diff.txt:"
          cat metadata-diff.txt

      # 11. Upload the diff output as an artifact.
      - name: Upload Comparison Artifact
        uses: actions/upload-artifact@v4
        with:
          name: metadata-diff
          path: metadata-diff.txt
